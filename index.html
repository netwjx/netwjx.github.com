
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>netwjx</title>
  <meta name="author" content="netwjx">

  
  <meta name="description" content="有时不方便使用通用编程语言完成一些常见的目标, 会考虑使用命令行, 但是命令行的资料不容易找, 主要因为它有不少是字母和符号, 基本上搜索引擎会忽略这些特殊符号, 所以这里收集一些这方面的技巧. 下面代码示例中rem表示对下一行的注释, 一般下一行以&gt;开始, 表示在命令提示符中输入的, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://netwjx.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="netwjx" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">netwjx</a></h1>
  
    <h2>混乱与有序</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="订阅Feed">Feed</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:netwjx.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <!-- <li><a href="/blog/categories">分类</a></li> -->
  <li><a href="/blog/archives">存档</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/19/windows-shell-and-bat-skills/">Windows命令行和批处理技巧</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-19T23:27:00+08:00" pubdate data-updated="true">2012-05-19</time>
        
         | <a href="/blog/2012/05/19/windows-shell-and-bat-skills/#comments">评论</a><a href="/blog/2012/05/19/windows-shell-and-bat-skills/#disqus_thread" class="comment-count"></a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>有时不方便使用通用编程语言完成一些常见的目标, 会考虑使用命令行, 但是命令行的资料不容易找, 主要因为它有不少是字母和符号, 基本上搜索引擎会忽略这些特殊符号, 所以这里收集一些这方面的技巧.</p>

<p>下面代码示例中<code>rem</code>表示对下一行的注释, 一般下一行以<code>&gt;</code>开始, 表示在命令提示符中输入的, 再下一行表示大概的输出. 整块的代码一般是文件内容, 将会以文件中的形式表现.</p>

<h2>打开命令行</h2>

<p>除了<code>Win+R cmd</code>打开外, 还可以在文件窗口中按住<strong>Shift + 鼠标右键</strong>, <strong>在此处打开命令窗口</strong>, 在文件夹上<strong>Shift + 鼠标右键</strong>同样有这个菜单项.</p>

<h2 id="multi-commands">在一行执行多个命令</h2>


<ul>
<li><p><code>command1 &amp; command2</code></p>

<p>先执行command1, 然后是command2, 一般在<code>cmd</code>开启新的命令提示符窗口时比较有用</p>

<pre><code>cmd echo 1 &amp;&amp; echo 2 &amp;&amp; echo 3
</code></pre></li>
<li><p><code>command1 &amp;&amp; command2</code></p>

<p>先执行command1, 如果执行成功(退出码为0), 将会接着执行command2</p></li>
<li><p><code>command1 || command2</code></p>

<p>和<code>&amp;&amp;</code>相反, 如果command1执行失败将会执行command2</p></li>
<li><p><code>(command1 &amp; command2)</code></p>

<p><code>()</code>用于组合嵌入多个命令, 可以在其中使用换行符, 将类似<code>&amp;</code>的效果, 只是写成了多行, 在<code>for</code>和<code>if</code>中很有用</p>

<pre><code>if not defined foo (
    set foo = bar
)
</code></pre></li>
<li><p><code>command1 param1;param2</code></p>

<p>分割命令的参数, 也可以使用符号<code>,</code>.</p></li>
</ul>


<p>如果命令参数中有<code>&amp;</code> <code>|</code> <code>()</code> <code>&gt;</code> <code>&lt;</code> <code>^</code>则需要使用<code>^</code>转义</p>

<pre><code>&gt;echo ^&amp;
&amp;
</code></pre>

<h2>环境变量</h2>

<p>set命令用于基本的查看和设置环境变量</p>

<pre><code>&gt;set
....
USERNAME=netwjx

&gt;set user
USERNAME=netwjx

&gt;set username
USERNAME=netwjx

&gt;set myvar=varvalue
</code></pre>

<p>同样的, 如果变量值包含<code>&amp;</code> <code>|</code> <code>&gt;</code> <code>&lt;</code> <code>^</code>, <a href="#multi-commands">使用<code>^</code>转义符</a></p>

<p>set命令的进一步使用可用来计算数字</p>

<pre><code>&gt;set /p expr=输入时间,单位分钟,例如:5*60+35
输入时间,单位分钟,例如:5*60+35
&gt;3*60+11
&gt;set /a sec=%expr%
191
&gt;echo %sec%
191
</code></pre>

<p>使用环境变量</p>

<pre><code>&gt;echo %myvar%&gt; foo.txt
</code></pre>

<p><code>%myvar%</code>将会被替换成变量值, 并将这个值输出到<code>foo.txt</code>.</p>

<p>检测环境变量是否有定义</p>

<pre><code>if not defined foo (
    echo need %foo%
)
</code></pre>

<p>在执行一行命令时, <code>%myvar%</code>的替换将只会执行一次, 所以在<code>for</code> <code>if</code>或者<code>()</code>组合的多个命令中, 如果变量被修改过, 则需要使用叹号<code>!</code>扩住变量名</p>

<pre><code>set VAR=before
if "%VAR%" == "before" (
    set VAR=after
    if "!VAR!" == "after" @echo If you see this, it worked
)
</code></pre>

<p>在<code>for</code>的<code>do</code>部分, 只有<code>for</code>的循环变量是个特例, 每次执行循环都会被替换为循环变量</p>

<h3>获取一个命令行的输出到环境变量</h3>

<p>执行<code>set</code>命令, 并将每行的内容作为循环变量%i输出</p>

<pre><code>&gt;for /f %i in ('set') do @echo %i
...
windir=C:\windows
</code></pre>

<p>有时可能不方便使用单引号<code>'</code>, 可以使用反引号<code>`</code></p>

<pre><code>&gt;for /f "usebackq" %i in (`set`) do @echo %i
...
windir=C:\windows
</code></pre>

<p>更多关于<a href="#for-command"><code>for</code>命令</a></p>

<h3 id="built-in-var">内建环境变量</h3>


<p>内建环境变量是在执行变量替换的时候最先检查的, 其中也有一些比较有用的</p>

<ul>
<li><p><code>%ALLUSERSPROFILE%</code></p>

<p>返回<strong>所有用户</strong>的数据目录, 对于Win7, 它是<code>C:\ProgramData</code></p></li>
<li><p><code>%APPDATA%</code></p>

<p>返回当前用户的应用程序数据存储目录</p></li>
<li><p><code>%CD%</code></p>

<p>返回当前活动目录</p></li>
<li><p><code>%CMDCMDLINE%</code></p>

<p>返回当前命令行解释器的路径, 结果是被双引号<code>"</code>括起来的</p></li>
<li><p><code>%CMDEXTVERSION%</code></p>

<p>返回当前命令行处理扩展的版本号</p></li>
<li><p><code>%COMPUTERNAME%</code></p>

<p>返回当前计算机名称</p></li>
<li><p><code>%COMSPEC%</code></p>

<p>和<code>%CMDCMDLINE%</code>基本一样, 只是结果不是被双引号<code>"</code>括起来的</p></li>
<li><p><code>%DATE%</code></p>

<p>返回当前的日期, 格式和<code>date /t</code>命令相同, 这个还和系统的区域和语言设置有关, 实际处理起来通用性不是很好.</p></li>
<li><p><code>%ERRORLEVEL%</code></p>

<p>返回最近一次命令的执行结果, 一般非0表示发生了错误.</p></li>
<li><p><code>%HOMEDRIVE%</code></p>

<p>返回用户目录所在的盘符, 格式如<code>C:</code></p></li>
<li><p><code>%HOMEPATH%</code></p>

<p>返回用户目录的路径, 不包括盘符, 格式如<code>\Users\netwjx</code></p></li>
<li><p><code>%HOMESHARE%</code>, <code>%LOGONSEVER%</code></p>

<p>文档中有, 但是我没测试出来有效值</p></li>
<li><p><code>%NUMBER_OF_PROCESSORS%</code></p>

<p>返回系统的处理器数量</p></li>
<li><p><code>%OS%</code></p>

<p>返回操作系统名称, 基本上Win2000以后都是<code>Windows_NT</code></p></li>
<li><p><code>%PATH%</code></p>

<p>可执行文件的搜索路径</p></li>
<li><p><code>%PATHEXT%</code></p>

<p>可执行文件后缀</p></li>
<li><p><code>%PROCESSOR_ARCHITECTURE%</code></p>

<p>返回处理器架构, <code>x86</code> <code>IA64</code></p></li>
<li><p><code>%PROCESSOR_IDENTIFIER%</code></p>

<p>返回处理器描述</p></li>
<li><p><code>%PROCESSOR_LEVEL%</code></p>

<p>返回处理器的系列编号</p></li>
<li><p><code>%PROCESSOR_REVISION%</code></p>

<p>返回处理器的修订编号</p></li>
<li><p><code>%PROMPT%</code></p>

<p>返回当前命令提示符窗口的提示符, 可以通过<code>prompt</code>命令修改</p></li>
<li><p><code>%RANDOM%</code></p>

<p>返回一个随机数字, 范围在0到32767之间</p></li>
<li><p><code>%SYSTEMDRIVE%</code></p>

<p>返回操作系统所在的盘符</p></li>
<li><p><code>%SYSTEMROOT%</code></p>

<p>返回操作系统的根路径, 包含盘符</p></li>
<li><p><code>%TEMP%</code> <code>%TMP%</code></p>

<p>返回当前用户的临时目录</p></li>
<li><p><code>%TIME%</code></p>

<p>返回当前的时间, 格式类似<code>time /t</code>命令返回的, 这个还和系统的区域和语言设置有关, 实际处理起来通用性不是很好.</p></li>
<li><p><code>%USERDOMAIN%</code></p>

<p>返回当前用户所在的域, 或工作组名</p></li>
<li><p><code>%USERNAME%</code></p>

<p>返回当前登录的用户</p></li>
<li><p><code>%USERPROFILE%</code></p>

<p>返回当前用户目录</p></li>
<li><p><code>%WINDIR%</code></p>

<p>返回当前操作系统的路径, 类似<code>%SYSTEMROOT%</code></p></li>
</ul>


<p>在内建环境变量中没有指定名称的变量后, 会依次从下面的位置查找</p>

<ul>
<li>系统变量</li>
<li>当前用户变量</li>
<li>Autoexec.bat 中定义的变量</li>
<li>登录脚本中定义的变量(如果有提供登录脚本)</li>
<li>当前命令提示符窗口或批处理中定义的变量</li>
</ul>


<h2>管道和重定向</h2>

<p>一个常见的场景, 查找使用特定网络端口的应用程序</p>

<pre><code>&gt;netstat -ano | find ":4000"
  UDP    0.0.0.0:4000           *:*                                    3876
</code></pre>

<p>其中最右边的<strong>3876</strong>是应用程序的进程ID, 而<code>|</code>是管道操作符.</p>

<p>管道操作将会把左边命令的输出, 作为右边命令的输入. 上面例子中<code>netstat -ano</code>将会输出本机的网络连接和对应的进程, <code>find ":4000"</code>则是在输入中找包含字符串<code>:4000</code>的行.</p>

<p>重定向和管道也很相似, 典型的用途是将一个命令的输出保存为文本文件.</p>

<pre><code>&gt;netstat -ano &gt; foo.txt
</code></pre>

<p>可以在当前目录中看到<code>foo.txt</code>, 其内容是<code>netstat -ano</code>命令的输出.</p>

<p>可以和管道操作结合, 将查出来的本地网络连接信息保存到文件</p>

<pre><code>?netstat -ano | find ":4000" &gt; foo.txt
</code></pre>

<p><code>&gt;</code>会始终覆盖原来的文件, 使用<code>&gt;&gt;</code>则会在文件结尾添加</p>

<pre><code>&gt;netstat -ano &gt;&gt; foo.txt
</code></pre>

<p>随着反复的运行, <code>foo.txt</code>的结尾会一直增加.</p>

<p>有一个特殊的输出设备叫<code>nul</code>, 它不会产生任何文件, 效果就像执行了命令, 但是不回显命令的输出, 在<a href="#sleep-ping">延迟 Sleep</a>有这个例子.</p>

<p>上述可以将命令正常执行的结果重定向到文件, 但是错误信息仍旧会输出到命令提示符窗口(<strong>标准输出</strong>)</p>

<pre><code>&gt;netstat -x &gt; nul

显示协议统计和当前 TCP/IP 网络连接。

NETSTAT [-a] [-b] [-e] [-f] [-n] [-o] [-p proto] [-r] [-s] [-t] [interval]
....
</code></pre>

<p>默认错误信息输出的目标叫<strong>标准错误输出</strong>, 仍旧可以让其不显示</p>

<pre><code>&gt;netstat -x &gt; nul 2&gt;&amp;1
</code></pre>

<p>其中<code>&gt;&amp;</code>也是重定向操作符, 需要配合<code>&gt;</code> <code>&gt;&gt;</code>使用, 2<strong>标准错误输出</strong>, 1表示<strong>标准输出</strong>.</p>

<p><code>&gt; nul 2&gt;&amp;1</code>表示在将标准输出重定向到<code>nul</code>的同时将<strong>标准错误输出</strong>重定向到<strong>标准输出</strong>, 这样就完成了完全隐藏命令行输出的正常信息和错误信息.</p>

<p>关于重定向的数字下面是完整的参考</p>

<ul>
<li><p><code>0</code> STDIN</p>

<p>标准输入, 键盘输入</p></li>
<li><p><code>1</code> STDOUT</p>

<p>标准输出, 命令提示符窗口输出</p></li>
<li><p><code>2</code> STDERR</p>

<p>标准错误输出, 命令提示符窗口输出</p></li>
<li><p><code>3-9</code> UNDEFINED</p>

<p>未定义, 参考文档中描述其在特定应用程序中会使用, 但是没找到具体使用的例子, 所以我目前也不清楚具体使用是怎么样的.</p></li>
</ul>


<p>如果仅想取得命令的错误信息可以这样</p>

<pre><code>&gt;netstat -x 2&gt; foo.txt
</code></pre>

<p>在<a href="#ref-links">参考链接</a>中<strong>Using filters</strong>有管道和重定向混合使用示例.</p>

<h3>输入重定向</h3>

<p>上面的重定向都是输出重定向, 这里开始介绍输入重定向.</p>

<p>在介绍管道的时候使用了<code>find</code>命令, 它会在<strong>标准输入</strong>中查找指定字符串, 除了使用管道外, 还可以使用输入重定向</p>

<pre><code>&gt; netstat -ano &gt; foo.txt
&gt; find ":4000" &lt; foo.txt
  UDP    0.0.0.0:4000           *:*                                    3876
</code></pre>

<p>这会使用中间文件<code>foo.txt</code></p>

<p>而<strong>标准输入</strong>实际是个特殊的输入设备<code>con</code></p>

<pre><code>&gt;find "foo" &lt; con
</code></pre>

<p>等价于</p>

<pre><code>&gt;find "foo"
</code></pre>

<p>每当输入包含foo的字符串并回车后, 会立即回显一次.</p>

<p>比如使用用户输入来创建文件</p>

<pre><code>&gt;copy con foo.txt
&gt;bar
&gt;hello world
&gt;^Z
已复制         1 个文件。
</code></pre>

<p>其中<code>^Z</code>表示<code>Ctrl+Z</code>, 输入结束.</p>

<p>除了<code>find</code>会使用标准输入外, 常见的还有下列命令也会使用标准输入</p>

<ul>
<li><p><code>more</code></p>

<p>用于逐屏显示标准输入</p></li>
<li><p><code>sort</code></p>

<p>按行排序标准输入</p></li>
</ul>


<p>还有一个<code>&lt;&amp;</code>重定向操作符, 文档中的解释是会从右边的设备读取输入, 并从左边输出, 我实在想不出来这具体是在什么场景下使用, 所以也不知道如何介绍.</p>

<p>在<a href="#ref-links">参考链接</a>中<strong>Using filters</strong>有管道和重定向混合使用示例.</p>

<h2>在多个目录间切换工作目录</h2>

<pre><code>&gt;pushd d:\foo
</code></pre>

<p>将当前工作目录保存后, 立即将工作目录切换到<code>d:\foo</code>.</p>

<pre><code>&gt;popd
</code></pre>

<p>将当前工作目录切换到最近一次<code>pushd</code>时所在的工作目录.</p>

<p>很典型的一个栈stack结构, push和pop. stack为空时pop将没有任何效果.</p>

<p>比<code>cd</code>命令好用的是<code>cd</code>在跨盘符的时候还需要手工切换盘符.</p>

<h2 id="sleep-ping">延迟 Sleep</h2>


<pre><code>&gt;ping -n 4 -w 1000 127.0.0.1 &gt; nul
</code></pre>

<p>这将会延迟3秒, 其中<code>-n</code>参数表示的是重复ping的次数, 将决定最终的延迟的时间.</p>

<p>因为<code>ping 127.0.0.1</code>会立即返回, 所以实际延迟的时间是 <code>-n</code>参数 - 1 的秒数.</p>

<h2>echo特殊字符</h2>

<p>一般使用<code>%</code>作为转义字符</p>

<pre><code>&gt;echo %username%
netwjx

&gt;echo %%username%
%netwjx
</code></pre>

<p>但是<code>&amp;</code> <code>|</code>需要使用<code>^</code>转义, 这个在上面<a href="#multi-commands">在一行执行多个命令</a>已经有描述</p>

<pre><code>&gt;echo ping -n 3 127.0.0.1^&gt;nul
ping -n 3 127.0.0.1^&gt;nul

&gt;echo netstat -ano^|find ":80"
netstat -ano|find ":80"
</code></pre>

<p>P.S. Linux下echo转义符号是<code>\</code></p>

<p>空行, 在echo紧跟<code>.</code></p>

<pre><code>&gt;echo.
</code></pre>

<p>使用echo和输出重定向可以产生文本文件, 可以用来产生脚本批处理等.</p>

<h2 id="for-command">for命令</h2>


<p>如果在批处理文件中使用<code>for</code>则需要将<code>%i</code>写为<code>%%i</code>, 象下面这样</p>

<pre><code>&gt;for /f %%i in ('set') do @echo %%i
</code></pre>

<p>使用<code>for</code>命令的循环变量时, 可以使用类似批处理哪样的<a href="#batch-param-modifiers">参数修饰符</a></p>

<pre><code>&gt;for %I in (*.log) do @echo %~nxI
log.log
....
</code></pre>

<p>下面例子将使用在命令提示符窗口中的写法, 而不是批处理文件中的写法.</p>

<p><code>for</code>命令一般是用于处理多个文件, 文件的多行, 也可以用于处理另外一个命令的输出. 下面是显示<code>*.log</code>文件的例子</p>

<pre><code>&gt;for %i in (*.log) do @echo %i
C:\Log\log.log
....
</code></pre>

<p>匹配目录</p>

<pre><code>&gt;for /d %i in (.*) do @echo %i
.svn
....
</code></pre>

<p>枚举当前目录所有<strong>.txt</strong>文件</p>

<pre><code>&gt;for /r %i in (*.txt) do @echo %i
C:\foo.txt
C:\bar\foo.txt
....
</code></pre>

<p>枚举所有名字以<code>.</code>开始目录, 主要是指<code>.svn .hg</code>这些</p>

<pre><code>&gt;for /d /r %i in (.*) do @echo %i
C:\Users\Netwjx\.ssh
....
</code></pre>

<p>数字的循环变量</p>

<pre><code>&gt;for /l %i in (0, 1, 5) do @echo %i
0
1
2
3
4
5
</code></pre>

<p>注意初始值<code>0</code>和最大值<code>5</code>, 都会包含在内, 也就是这个循环将执行<strong>6次</strong>.</p>

<p>显示文件中的每行, 从开始到第一个空格到<code>tab</code>之间的字符串</p>

<pre><code>&gt;for /f %i in (mylog.log) do @echo %i
15:07:50.947:
15:07:50.947:
15:07:50.947:
....
</code></pre>

<p><code>/f</code>还可以使用一些参数, 下面将会把<code>path</code>环境变量的第一个<code>;</code>之前的内容输出</p>

<pre><code>&gt;for /f "usebackq delims=;= tokens=2" %i in (`set path`) do @echo %i
C:\Ruby\bin
.COM
</code></pre>

<p>详细参数如下, 空格分割</p>

<ul>
<li><p><code>eol=c</code></p>

<p>指定行注释字符, 以<code>c</code>字符开始的行将被忽略</p></li>
<li><p><code>skip=n</code></p>

<p>指定忽略开始的n行</p></li>
<li><p><code>delims=xxx</code></p>

<p>指定分割字符, 可以指定多个, 配合<code>tokens</code>参数使用, 类似传统编程语言中<code>split</code>函数的分割字符</p></li>
<li><p><code>tokens=x,y,m-n</code></p>

<p>将<code>x y</code>以及<code>m-n</code>之间的字符串返回给循环变量, 下标从1开始, 如果有<code>y*</code>,则表示从第<code>y</code>个往后的所有都返回.</p></li>
<li><p><code>usebackq</code></p>

<p>表示使用<code>`</code>符号表示一个命令行, 而不是传统的<code>'</code>符号</p></li>
</ul>


<p>配合自定义的命令行程序, 可以自行处理命令提示符窗口的输入和输出, 以及弥补<a href="#built-in-var">内建环境变量</a>中<code>%date%</code>和<code>%time%</code>格式不固定的问题.</p>

<h3>查询注册表</h3>

<p>这是个使用<code>for</code>执行命令并取得命令执行结果到变量的典范.</p>

<pre><code>&gt;for /f "tokens=3 skip=2" %i in ('reg query HKEY_CLASSES_ROOT\txtfile\shell\open\command /ve') do @echo %i
C:\windows\notepad.exe
</code></pre>

<p>其中<code>reg query</code>命令是读取注册表, 返回的内容类似下面</p>

<pre><code>HKEY_CLASSES_ROOT\txtfile\shell\open\command
(默认)    REG_SZ    C:\windows\notepad.exe %1
</code></pre>

<p>因为其开始会有一个空行, 所以<code>/f</code>参数有<code>skip=2</code></p>

<h2>批处理文件</h2>

<p>批处理文件可以是<code>bat</code>后缀, 也可以是<code>cmd</code>后缀.</p>

<p>批处理文件需要保存为ANSI格式, 对于中文Windows是GBK, 不建议用<strong>UTF-8</strong>, 也不建议有<strong>BOM</strong></p>

<h3>不回显输入的命令</h3>

<p>以<code>@</code>开始的命令将不会回显</p>

<pre><code>&gt;@echo hello
</code></pre>

<p>同时可以使用<code>echo off</code>关闭回显, 如果两者结合的话就是</p>

<pre><code>&gt;@echo off
</code></pre>

<p>一般在批处理文件第一行, 可以使所有命令都不回显.</p>

<p>一般调试时可能会需要在某行之后回显, 可以再<code>echo on</code>打开回显.</p>

<h3>批处理参数</h3>

<p>使用<code>%1</code>到<code>%9</code>获取, 其中<code>%0</code>是当前批处理文件的路径.</p>

<figure class='code'><figcaption><span>Foo\test.bat</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bat'><span class='line'><span class="p">@</span><span class="k">echo</span> <span class="k">off</span>
</span><span class='line'><span class="k">echo</span> <span class="nv">%0</span>
</span><span class='line'><span class="k">echo</span> <span class="nv">%1</span>
</span><span class='line'><span class="k">echo</span> <span class="nv">%2</span>
</span><span class='line'><span class="k">echo</span> <span class="nv">%3</span>
</span><span class='line'><span class="k">echo</span> <span class="nv">%4</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用示例</p>

<pre><code>&gt;Foo\test.bat 1 2 3 4
Foo\test.bat
1
2
3
4
</code></pre>

<p><code>%0</code> 可用来删除脚本自身, 不过这行必须放结尾, 因为一旦删除就会脚本执行出错.</p>

<p>可以用<code>if</code>检测参数是否提供</p>

<pre><code>&gt;if not "%4"=="" echo %4
</code></pre>

<p>1-9不够用可以使用<code>shift</code></p>

<pre><code>&gt;rem 将参数队列弹出一个, 这将会使旧的%1值被移除, 旧的%2变成%1, 旧的%3变成%2
&gt;shift
&gt;rem 和上面的类似, 只是一次弹出2个, 旧的%1 %2被移除, 旧的%3 %4 %5将变成%1 %2 %3
&gt;shift /2
</code></pre>

<p>如果仅需要将当前的参数原封不动的传递给别的命令行程序, 使用<code>%*</code></p>

<pre><code>&gt;call foo.bat %*
</code></pre>

<p><code>%*</code>将包含原始的<code>%1-%n</code>的参数, 不受<code>shift</code>影响, <code>%*</code><strong>不能使用</strong><a href="#batch-param-modifiers">参数修饰符</a></p>

<h3 id="batch-param-modifiers">参数修饰符</h3>


<p>参数修饰可以将指定参数扩展为文件或目录名, 使用当前的盘符和目录信息.</p>

<pre><code>&gt;rem 把%1参数扩展为包含盘符和路径的字符串
&gt;echo %~dp1
</code></pre>

<p>完整的修饰符列表</p>

<ul>
<li><p><code>%~1</code></p>

<p>扩展%1参数并移除参数两边的双引号<code>"</code></p></li>
<li><p><code>%~f1</code></p>

<p>扩展%1参数为完整的路径</p></li>
<li><p><code>%~d1</code></p>

<p>扩展%1参数为盘符</p></li>
<li><p><code>%~p1</code></p>

<p>扩展%1参数为路径, 不包括盘符和文件名</p></li>
<li><p><code>%~n1</code></p>

<p>扩展%1参数为文件名, 不包括扩展名</p></li>
<li><p><code>%~x1</code></p>

<p>扩展%1参数为扩展名, 包含点</p></li>
<li><p><code>%~s1</code></p>

<p>扩展%1参数为仅包含短名称目录名的路径</p></li>
<li><p><code>%~a1</code></p>

<p>扩展%1参数为文件属性, 格式如<code>--a------</code>, 其它标志位的字母可以自行测试</p></li>
<li><p><code>%~t1</code></p>

<p>扩展%1参数为文件修改时间, 格式如<code>2011/07/31 17:04</code></p></li>
<li><p><code>%~z1</code></p>

<p>扩展%1参数为文件大小的数字, 单位字节</p></li>
<li><p><code>%~$PATH:1</code></p>

<p>在PATH环境变量中指定的所有目录中(分号<code>;</code>分割的目录路径)搜索名为%1的文件名, 返回第一个发现的文件路径, 如果环境变量不存在或者找不到文件, 将返回空白的字符串</p></li>
</ul>


<p>上述的修饰符和多重叠加</p>

<pre><code>&gt;rem 搜索PATH环境变量的路径中名为%1的文件, 并返回第一个找到的文件的盘符和路径
&gt;echo %~dp$PATH:1
</code></pre>

<h3>调用其它批处理</h3>

<p>一般是可以直接<code>other.bat</code>, 但是可能会发生一些奇怪的现象, 如后续的命令未执行之类的, 所以</p>

<pre><code>&gt;call other.bat arg1 arg2
</code></pre>

<h3>goto跳转到标记</h3>

<p>和传统编程语言中的用法一样</p>

<pre><code>if "%1"=="" goto help

echo running
....
goto end

:help
echo help message
goto :EOF

:end
echo completed
</code></pre>

<p>标记使用<code>:label</code>来定义, 然后是<code>goto label</code>跳转.</p>

<p>有一个特殊标记<code>:EOF</code>表示结束, 使用时是<code>goto :EOF</code>.</p>

<h2 id="ref-links">参考链接</h2>


<ul>
<li><p><a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/batch.mspx?mfr=true">Using batch files</a></p></li>
<li><p><a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/percent.mspx">Using batch parameters</a></p></li>
<li><p><a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/redirection.mspx?mfr=true">Using command redirection operators</a></p></li>
<li><p><a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/filters.mspx?mfr=true">Using filters</a></p></li>
<li><p><a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/cmd.mspx">Cmd</a></p></li>
<li><p><a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/ntcmds_shelloverview.mspx">Command shell overview</a></p></li>
</ul>

</div>
  
    <footer>
  
  
      <a href="/blog/2012/05/19/windows-shell-and-bat-skills/#comments">评论</a><a href="/blog/2012/05/19/windows-shell-and-bat-skills/#disqus_thread" class="comment-count"></a>
  
    </footer>


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/19/csharp-delegate-and-lambda/">C#委托和Lambda表达式</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-19T19:54:00+08:00" pubdate data-updated="true">2012-05-19</time>
        
         | <a href="/blog/2012/05/19/csharp-delegate-and-lambda/#comments">评论</a><a href="/blog/2012/05/19/csharp-delegate-and-lambda/#disqus_thread" class="comment-count"></a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>C#算是个多范式编程语言, 除了传统的OO风格, 还可以在部分范围中使用函数式编程的风格, 这里整理一下C#中委托和Lambda实践中的各种写法.</p>

<p>这里不会解释具体的代码含义, 仅仅介绍写法, 可能不适合刚开始学习.</p>

<h2>声明委托类型</h2>

<p>使用前必须要有具体的委托类型, 下面的例子中会使用到这些常用的委托类型</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">delegate</span> <span class="k">void</span> <span class="nf">Action</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">delegate</span> <span class="k">void</span> <span class="n">Action</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T1</span><span class="p">,</span> <span class="k">in</span> <span class="n">T2</span><span class="p">&gt;(</span><span class="n">T1</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">T2</span> <span class="n">arg2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">delegate</span> <span class="kt">bool</span> <span class="n">Predicate</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">obj</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">delegate</span> <span class="n">TResult</span> <span class="n">Func</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T1</span><span class="p">,</span> <span class="k">in</span> <span class="n">T2</span><span class="p">,</span> <span class="k">out</span> <span class="n">TResult</span><span class="p">&gt;(</span><span class="n">T1</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">T2</span> <span class="n">arg2</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Action</code>和<code>Action&lt;in T1, in T2&gt;</code>是在dotnet 3.5 sp1出现的一个很实用的委托, 类似的还有1-16个参数的, 这里主要使用这2种.</p>

<p><code>Predicate</code>是从dotnet 2.0就出现的, 一般是在泛型集合的查询中使用.</p>

<p><code>Func&lt;in T1, in T2, out TResult&gt;</code>也是dotnet 3.5 sp1出现的, 和<code>Action</code>基本一样, 也有1-16个参数的, 和Action不同的是这个委托都声明有返回值类型, 而不是<code>Action</code>的void.</p>

<h2>最初的写法</h2>

<p>最简单的<code>Action</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Action</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Action</span><span class="p">(</span><span class="n">Foo</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Foo</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>对于复杂的委托, 比如<code>Func</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;(</span><span class="n">Foo</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">bool</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">string</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>匿名委托</h2>

<p>和上一个区别就是不需要创建<code>Foo</code>方法了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Action</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Action</span><span class="p">(</span><span class="k">delegate</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Predicate</code>就是这样的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">delegate</span><span class="p">(</span><span class="kt">string</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>右边的<code>new xxxx()</code> 可以省略</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Action</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">string</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于也是一行代码, 结尾的分号还是必须的.</p>

<p>也适用于<strong>最初的写法</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">bool</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">string</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果使用的是dotnet 4的编译器, 可以使用<code>var</code>, 看起来就像是颠倒过来了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;(</span><span class="k">delegate</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">string</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>var</code>是编译器提供的<strong>魔法</strong>, 会自动推导<code>=</code>右边的类型, 当然前提是右边的可以推导出来类型, 无法推导出来就会编译错误.</p>

<h2>Lambda登场</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Action</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;hello, world&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">Action</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span> <span class="p">+</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;bar&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="n">i</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>语法方面, 无参数要写成<code>()</code>, 1个参数可以省略括号, 2个及更多参数则必须括号<code>()</code>; <code>=&gt;</code> 右边必须有表达式; 表达式结果必须是委托的返回值类型, 如果委托返回值类型是void则无所谓表达式结果类型.</p>

<p>Lambda也算是编译器魔法, 上述Lambda表达式特点都是左边的委托类型明确, 即委托的参数, 返回值也是明确的, 和<code>var</code>相似, 类型是可推导出来的, 那么就可以使用Lambda, 这样就省了写一堆的参数类型和return语句.</p>

<p>实际使用中可能是这样的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'><span class="n">list</span><span class="p">.</span><span class="n">FindAll</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;bar&quot;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>即除了声明变量, 参数是明确的委托类型时, 也可以使用Lambda.</p>

<p>Lambda的<code>=&gt;</code>右边也可以是多行代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="p">=&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h2>委托可以叠加</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Action</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="n">foo</span> <span class="p">+=</span> <span class="p">()=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;bar&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">foo</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="n">foo</span> <span class="p">+=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="n">i</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>执行时会按照先加先执行的顺序, 如果有返回值, 那么将使用最后加进来的委托的返回值.</p>

<p>同样也可以从叠加的里面减去, 不过这里是按引用, 所以需要保留一个加进去的委托引用.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Action</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="n">Action</span> <span class="n">bar</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">foo</span><span class="p">+=</span><span class="n">bar</span><span class="p">;</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="n">foo</span><span class="p">-=</span><span class="n">bar</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>事件</h3>

<p>C#提供了一个<code>event</code>关键字用于声明一种特殊的委托, 可以在类外部<code>+=</code> <code>-=</code>, 但是执行委托只能在内部</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">event</span> <span class="n">EventHandle</span> <span class="n">Foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="nf">Bar</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Foo</span> <span class="p">+=</span> <span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Foo Event&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="nf">Bar2</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Foo</span><span class="p">(</span><span class="k">new</span> <span class="kt">object</span><span class="p">(),</span> <span class="n">EventArgs</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>默认的事件实现中<code>+=</code> <code>-=</code>是线程安全的, 这点可以在反编译<code>event</code>的源码中看到, 如果要自行实现<code>event</code>的<code>+=</code> <code>-=</code>则需要自行处理线程安全.</p>

<h2>总结</h2>

<p>使用委托可以避免创建太多的中间方法, 而使用Lambda, 则可以使在写委托的时候避免大量的<code>delegate</code>关键字和重复的委托参数类型声明.</p>

<p>也许会让代码不是很容易理解, 但是只要遵循一些约定, 熟悉了还是没关系的.</p>

<p>重要的是这会少写很多重复的东西, 同样修改时也少修改一些东西.</p>

<h2>参考链接</h2>

<ul>
<li><a href="http://msdn.microsoft.com/zh-cn/library/aa664629%28v=vs.71%29">C# 语言规范 1.10 委托</a></li>
<li><a href="http://msdn.microsoft.com/zh-cn/library/ms173171%28v=vs.80%29.aspx">委托（C# 编程指南）</a></li>
<li><a href="http://msdn.microsoft.com/zh-cn/library/900fyy8e%28v=vs.80%29.aspx">委托（C# 参考）</a></li>
<li><a href="http://msdn.microsoft.com/zh-cn/library/x53a06bb%28v=vs.80%29.aspx">C# 关键字</a></li>
<li><a href="http://msdn.microsoft.com/zh-cn/library/bb397687.aspx">Lambda 表达式（C# 编程指南）</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/bfcke1bz">Predicate<T> Delegate</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/bb549311">Action&lt;T1, T2> Delegate</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/system.action">Action Delegate</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/bb534647">Func&lt;T1, T2, TResult> Delegate</a></li>
</ul>

</div>
  
    <footer>
  
  
      <a href="/blog/2012/05/19/csharp-delegate-and-lambda/#comments">评论</a><a href="/blog/2012/05/19/csharp-delegate-and-lambda/#disqus_thread" class="comment-count"></a>
  
    </footer>


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/06/ruby-and-jekyll-note/">Ruby 和 Jekyll 的笔记</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-06T15:57:00+08:00" pubdate data-updated="true">2012-05-06</time>
        
         | <a href="/blog/2012/05/06/ruby-and-jekyll-note/#comments">评论</a><a href="/blog/2012/05/06/ruby-and-jekyll-note/#disqus_thread" class="comment-count"></a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>之前发现<a href="http://octopress.org/">Octopress</a>产生的页面中, <strong>meta</strong>标签的<strong>content</strong>属性没有处理换行, 今天尝试自己写个插件来处理这个地方, 因为没有学过Ruby, 下面的操作基本都是临时找资料, 所以记录一些重点.</p>

<p>插件代码如下</p>

<figure class='code'><figcaption><span>plugins/html_attr_filter.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#html attribute filter</span>
</span><span class='line'><span class="k">module</span> <span class="nn">HtmlAttrFilters</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">html_attr</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>        <span class="n">input</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\r\n|\r|\n/</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">=&gt;</span><span class="s1">&#39;&amp;#13;&amp;#10;&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="o">=&gt;</span><span class="s1">&#39;&amp;#13;&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">=&gt;</span><span class="s1">&#39;&amp;#10;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="o">.</span><span class="n">register_filter</span> <span class="no">HtmlAttrFilters</span>
</span></code></pre></td></tr></table></div></figure>


<p>修改<code>source/_includes/head.html</code>中<code>&lt;meta name="description"</code>所在的行</p>

<figure class='code'><figcaption><span>source/_includes/head.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;{{ description | strip_html | condense_spaces | truncate:150 | html_attr }}&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后<code>rake generate</code>就能看到<code>&lt;meta name="description"</code>的<strong>content</strong>已经不会有换行了, 下面说说中间涉及的相关东西.</p>

<h2>Jekyll扩展和Liquid扩展</h2>

<p><a href="http://octopress.org/">Octopress</a>是基于<a href="https://github.com/mojombo/jekyll">Jekyll</a>的, <a href="https://github.com/mojombo/jekyll">Jekyll</a>使用的模版引擎是<a href="https://github.com/Shopify/liquid/wiki">Liquid</a>, 在模版中<code>{{ a | foo | bar}}</code>的<code>foo</code>和<code>bar</code>叫做<strong>Filter</strong>, 后面将把其称为<strong>过滤器</strong>, 在<a href="https://github.com/mojombo/jekyll">Jekyll</a>的<a href="https://github.com/mojombo/jekyll/wiki/Plugins">插件开发文档</a>中有一段是关于过滤器扩展, 我主要是参考这里来做文章开始的扩展.</p>

<h3>Liquid filters</h3>

<p>You can add your own filters to the liquid system much like you can add tags above. Filters are simply modules that export their methods to liquid. All methods will have to take at least one parameter which represents the input of the filter. The return value will be the output of the filter.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Jekyll</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">AssetFilter</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">asset_url</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>      <span class="s2">&quot;http://www.example.com/</span><span class="si">#{</span><span class="n">input</span><span class="si">}</span><span class="s2">?</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="o">.</span><span class="n">register_filter</span><span class="p">(</span><span class="no">Jekyll</span><span class="o">::</span><span class="no">AssetFilter</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Advanced</strong>: you can access the <code>site</code> object through the <code>@context.registers</code> feature of liquid. Registers a hash where arbitrary context objects can be attached to. In Jekyll you can access the site object through registers. As an example, you can access the global configuration (_config.yml) like this: <code>@context.registers[:site].config['cdn']</code>.</p>

<h3>延伸: Octopress Jekyll和Liquid所有可用的过滤器</h3>

<p><a href="http://octopress.org/">Octopress</a>扩展的过滤器在<a href="https://github.com/imathis/octopress/blob/master/plugins/octopress_filters.rb">这里</a>, 主要是从36行开始的这些:</p>

<figure class='code'><figcaption><span>plugins/octopress_filters.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">OctopressLiquidFilters</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Octopress</span><span class="o">::</span><span class="no">Date</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Used on the blog index to split posts on the &lt;!--more--&gt; marker</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">excerpt</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">input</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sr">/&lt;!--\s*more\s*--&gt;/i</span><span class="p">)</span>
</span><span class='line'>      <span class="n">input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/&lt;!--\s*more\s*--&gt;/i</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">input</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Checks for excerpts (helpful for template conditionals)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">has_excerpt</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">input</span> <span class="o">=~</span> <span class="sr">/&lt;!--\s*more\s*--&gt;/i</span> <span class="p">?</span> <span class="kp">true</span> <span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Summary is used on the Archive pages to return the first block of content from a post.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">input</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sr">/\n\n/</span><span class="p">)</span>
</span><span class='line'>      <span class="n">input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/\n\n/</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">input</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Extracts raw content DIV from template, used for page description as </span>
</span><span class='line'>  <span class="c1"># contains complete sub-template code on main page level</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">raw_content</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="sr">/&lt;div class=&quot;entry-content&quot;&gt;(?&lt;content&gt;[\s\S]*?)&lt;\/div&gt;\s*&lt;(footer|\/article)&gt;/</span> <span class="o">=~</span> <span class="n">input</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">nil?</span><span class="p">)</span> <span class="p">?</span> <span class="n">input</span> <span class="p">:</span> <span class="n">content</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Escapes CDATA sections in post content</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">cdata_escape</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">input</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/&lt;!\[CDATA\[/</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;![CDATA[&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\]\]&gt;/</span><span class="p">,</span> <span class="s1">&#39;]]&amp;gt;&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Replaces relative urls with full urls</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">expand_urls</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">url</span> <span class="o">||=</span> <span class="s1">&#39;/&#39;</span>
</span><span class='line'>    <span class="n">input</span><span class="o">.</span><span class="n">gsub</span> <span class="sr">/(\s+(href|src)\s*=\s*[&quot;|&#39;]{1})(\/[^\&quot;&#39;&gt;]*)/</span> <span class="k">do</span>
</span><span class='line'>      <span class="vg">$1</span><span class="o">+</span><span class="n">url</span><span class="o">+</span><span class="vg">$3</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Improved version of Liquid&#39;s truncate:</span>
</span><span class='line'>  <span class="c1"># - Doesn&#39;t cut in the middle of a word.</span>
</span><span class='line'>  <span class="c1"># - Uses typographically correct ellipsis (…) insted of &#39;...&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">input</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">input</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/(.+)\b.+$/im</span>
</span><span class='line'>      <span class="vg">$1</span><span class="o">.</span><span class="n">strip</span> <span class="o">+</span> <span class="s1">&#39; &amp;hellip;&#39;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">input</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Improved version of Liquid&#39;s truncatewords:</span>
</span><span class='line'>  <span class="c1"># - Uses typographically correct ellipsis (…) insted of &#39;...&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">truncatewords</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'>    <span class="n">truncate</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">truncate</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">length</span>
</span><span class='line'>      <span class="n">truncate</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.length</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="o">+</span> <span class="s1">&#39; &amp;hellip;&#39;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">input</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Condenses multiple spaces and tabs into a single space</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">condense_spaces</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">input</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\s{2,}/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Removes trailing forward slash from a string for easily appending url segments</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">strip_slash</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">input</span> <span class="o">=~</span> <span class="sr">/(.+)\/$|^\/$/</span>
</span><span class='line'>      <span class="n">input</span> <span class="o">=</span> <span class="vg">$1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">input</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Returns a url without the protocol (http://)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">shorthand_url</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">input</span><span class="o">.</span><span class="n">gsub</span> <span class="sr">/(https?:\/\/)(\S+)/</span> <span class="k">do</span>
</span><span class='line'>      <span class="vg">$2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Returns a title cased string based on John Gruber&#39;s title case http://daringfireball.net/2008/08/title_case_update</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">titlecase</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="n">input</span><span class="o">.</span><span class="n">titlecase</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">Liquid</span><span class="o">::</span><span class="no">Template</span><span class="o">.</span><span class="n">register_filter</span> <span class="no">OctopressLiquidFilters</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>def</code>后的名称即过滤器的名称.</p>

<p><a href="https://github.com/mojombo/jekyll">Jekyll</a>扩展的过滤器在<a href="https://github.com/mojombo/jekyll/wiki/Liquid-Extensions">这里</a></p>

<p><a href="https://github.com/Shopify/liquid/wiki">Liquid</a>的标准过滤器在<a href="https://github.com/shopify/liquid/wiki/liquid-for-designers">这里</a></p>

<h2>Ruby的字符串和正则</h2>

<p>Ruby的字符串可以使用双引号<code>"foo bar"</code>, 也可以使用单引号<code>'foo bar'</code>, 区别是:</p>

<ul>
<li>双引号中可以使用<code>\r\n</code>等转义符号, 以及<code>#{bar}</code>来引入一个变量的值, <code>bar</code>表示一个变量名.</li>
<li>单引号会将所有的字符原样保留, 包括<code>\r\n</code>, 其等价于双引号的<code>\\r\\n</code>.</li>
</ul>


<p>Ruby字符串的替换可以使用<code>gsub</code>方法, 类似一般语言中的<code>replace</code>, 第一个参数仍旧可以为正则, Ruby的文档中代码示例如下:</p>

<figure class='code'><figcaption><span>String#gsub</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;hello&quot;</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[aeiou]/</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>                  <span class="c1">#=&gt; &quot;h*ll*&quot;</span>
</span><span class='line'><span class="s2">&quot;hello&quot;</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/([aeiou])/</span><span class="p">,</span> <span class="s1">&#39;&lt;\1&gt;&#39;</span><span class="p">)</span>             <span class="c1">#=&gt; &quot;h&lt;e&gt;ll&lt;o&gt;&quot;</span>
</span><span class='line'><span class="s2">&quot;hello&quot;</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/./</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">ord</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">}</span>      <span class="c1">#=&gt; &quot;104 101 108 108 111 &quot;</span>
</span><span class='line'><span class="s2">&quot;hello&quot;</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/(?&lt;foo&gt;[aeiou])/</span><span class="p">,</span> <span class="s1">&#39;{\k&lt;foo&gt;}&#39;</span><span class="p">)</span>  <span class="c1">#=&gt; &quot;h{e}ll{o}&quot;</span>
</span><span class='line'><span class="s1">&#39;hello&#39;</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[eo]/</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>    <span class="c1">#=&gt; &quot;h3ll*&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>我没有完整的看Ruby的语言规范, 根据文档的描述, 示例代码中最后一行<code>'e' =&gt; 3, 'o' =&gt; '*'</code>叫做<strong>Hash</strong>.</p>

<p>另外一个方法<code>sub</code>和<code>gsub</code>区别在: <code>sub</code>只会替换一次, <code>gsub</code>会替换所有的.</p>

<p>更多资料:</p>

<ul>
<li> <a href="http://www.ruby-doc.org/docs/ProgrammingRuby/html/tut_stdtypes.html">Ruby基础类型</a>中还有更多关于<code>String</code>类型的基础.</li>
<li> <a href="http://www.ruby-doc.org/core-1.9.3/String.html">类库参考 String</a>中有完整的<code>String</code>可使用.</li>
</ul>


<p>Ruby中正则的使用感觉和Javascript的十分象, 当然也有一些其它的语法, 详细参考<a href="http://www.ruby-doc.org/core-1.9.3/Regexp.html">Ruby类库参考 Regexp</a></p>

<p>发现一个特别的地方是Javascript中正则可以使用的选项有<code>igm</code>, 而Ruby是<code>imxo</code>, 见<a href="http://www.ruby-doc.org/core-1.9.3/Regexp.html">这里</a><strong>的Options</strong></p>
</div>
  
    <footer>
  
  
      <a href="/blog/2012/05/06/ruby-and-jekyll-note/#comments">评论</a><a href="/blog/2012/05/06/ruby-and-jekyll-note/#disqus_thread" class="comment-count"></a>
  
    </footer>


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/29/winforms-synchronizationcontext-and-invoke/">WinForms开发中SynchronizationContext和Invoke的使用注意事项</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-29T14:26:00+08:00" pubdate data-updated="true">2012-04-29</time>
        
         | <a href="/blog/2012/04/29/winforms-synchronizationcontext-and-invoke/#comments">评论</a><a href="/blog/2012/04/29/winforms-synchronizationcontext-and-invoke/#disqus_thread" class="comment-count"></a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>WinForms 开发中<a href="http://msdn.microsoft.com/zh-cn/library/zyzhdc6b.aspx">Control.Invoke</a>是用于非UI线程中请求修改UI元素的方法, 一般配合<a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.control.invokerequired.aspx">Control.InvokeRequired</a>使用:</p>

<figure class='code'><figcaption><span>Control.Invoke and Control.InvokeRequired</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Form1</span> <span class="p">:</span> <span class="n">Form</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">void</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">InvokeRequired</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Invoke</span><span class="p">((</span><span class="n">Action</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;)</span><span class="n">Foo</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">textBox1</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">text</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>类似<a href="http://msdn.microsoft.com/zh-cn/library/zyzhdc6b.aspx">Control.Invoke</a>的还有<a href="http://msdn.microsoft.com/zh-cn/library/0b1bf3y3.aspx">Control.BeginInvoke</a>和<a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.control.endinvoke.aspx">Control.EndInvoke</a>, 它们是异步调用.</p>

<p>这些方法和属性都依赖于<a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.control.ishandlecreated.aspx">IsHandleCreated</a>为<code>true</code>时, <a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.control.ishandlecreated.aspx">IsHandleCreated</a>表示窗口句柄是否已创建, 它并不是指是否<code>new Form1()</code>过, 而是指是否<code>Show()</code>过, 包括<a href="http://msdn.microsoft.com/zh-cn/library/ms157902.aspx">Application.Run</a>, <a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.control.show.aspx">Show</a>, <a href="http://msdn.microsoft.com/zh-cn/library/c7ykbedk.aspx">ShowDialog</a>这些调用都会使<a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.control.ishandlecreated.aspx">IsHandleCreated</a>为<code>true</code>.</p>

<p>而在<a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.control.ishandlecreated.aspx">IsHandleCreated</a>为<code>false</code>时, 比如刚刚<code>new Form1()</code>, <a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.control.invokerequired.aspx">Control.InvokeRequired</a>返回<code>false</code>, 调用<a href="http://msdn.microsoft.com/zh-cn/library/zyzhdc6b.aspx">Control.Invoke</a>会抛出异常:</p>

<pre><code>System.InvalidOperationException: 在创建窗口句柄之前，不能在控件上调用 Invoke 或 BeginInvoke。
</code></pre>

<p>当在非UI线程和多个窗口之间操作时, 可能会有一些麻烦的情况发生, 这种情况可能会考虑使用<a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.aspx">SynchronizationContext</a>.</p>

<p><a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.aspx">SynchronizationContext</a>可以在当前线程第一次<code>new Form1()</code>之后通过<a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.current.aspx">SynchronizationContext.Current</a>取得, 之后使用<a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.post.aspx">Post</a>和<a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.send.aspx">Send</a>实现在UI线程执行指定的委托, 下面使用的<a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.windowsformssynchronizationcontext.aspx">WindowsFormsSynchronizationContext</a>.Current在WinForms程序中等价于<a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.current.aspx">SynchronizationContext.Current</a>:</p>

<figure class='code'><figcaption><span>SynchronizationContext.Post</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Form1</span> <span class="p">:</span> <span class="n">Form</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">SynchronizationContext</span> <span class="n">SyncContext</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">Form1</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">InitializeComponent</span><span class="p">();</span>
</span><span class='line'>        <span class="n">SyncContext</span> <span class="p">=</span> <span class="n">WindowsFormsSynchronizationContext</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">void</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">SyncContext</span><span class="p">.</span><span class="n">Post</span><span class="p">(</span><span class="k">delegate</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">textBox1</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">text</span><span class="p">;</span>
</span><span class='line'>      <span class="p">},</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从<a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.current.aspx">SynchronizationContext.Current</a>的文档可知它只会返回当前线程的同步上下文, 要在别的线程中访问需要自行保存它的引用, 即这里属性<code>SyncContext</code>, 使用时确保在访问<code>SyncContext</code>之前<code>new Form1()</code>过一次, 且只能一次, 否则后续的会覆盖之前的, 在符合需求的情况下会很自然想到单例模式:</p>

<figure class='code'><figcaption><span>线程安全的单例模式</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="n">Form1</span><span class="p">[]</span> <span class="n">_Instance</span> <span class="p">=</span> <span class="p">{</span> <span class="k">null</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Form1</span> <span class="n">Instance</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">get</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">_Instance</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">lock</span> <span class="p">(</span><span class="n">_Instance</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">_Instance</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="n">_Instance</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Form1</span><span class="p">();</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_Instance</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>目前看起来是没什么问题了, 现实总是会出点问题, 比如<a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.current.aspx">SynchronizationContext.Current</a>总是返回当前线程的, 结合上述的单例模式, 如果第一次访问<code>Instance</code>属性是在别的线程中, 测试代码如下:</p>

<figure class='code'><figcaption><span>在不同的线程中访问Form1.Instance</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="k">delegate</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Form1</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">SynchronizationContext</span><span class="p">.</span><span class="n">Current</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'><span class="p">}).</span><span class="n">Start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">3000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">f</span> <span class="p">=</span> <span class="n">Form1</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>
</span><span class='line'><span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">SynchronizationContext</span><span class="p">.</span><span class="n">Current</span> <span class="p">==</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'><span class="n">Application</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面代码的两处断言都通过了, 这种情况下<a href="http://msdn.microsoft.com/zh-cn/library/system.threading.synchronizationcontext.post.aspx">Form1.SyncContext.Post</a>仍旧可以调用, 但是将<strong>不产生任何效果</strong>, 也<strong>不抛出异常</strong>, 因为<code>new Form1()</code>的那个线程已经结束了, 以及那个线程并没有执行消息循环<a href="http://msdn.microsoft.com/zh-cn/library/ms157902.aspx">Application.Run</a>.</p>

<p>如果需要在<a href="http://msdn.microsoft.com/zh-cn/library/ms157902.aspx">Application.Run</a>之后, 相关的UI元素变得可用时再执行相关代码, 可以自行定义事件, 实现相关的触发和绑定, 确保<code>new Form1</code>和<a href="http://msdn.microsoft.com/zh-cn/library/ms157902.aspx">Application.Run</a>在同一个线程中调用, 在具体的多线程环境中解决办法会表现的完全不同.</p>
</div>
  
    <footer>
  
  
      <a href="/blog/2012/04/29/winforms-synchronizationcontext-and-invoke/#comments">评论</a><a href="/blog/2012/04/29/winforms-synchronizationcontext-and-invoke/#disqus_thread" class="comment-count"></a>
  
    </footer>


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/21/using-code-in-octopress/">在Octopress中使用代码高亮</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-21T16:45:00+08:00" pubdate data-updated="true">2012-04-21</time>
        
         | <a href="/blog/2012/04/21/using-code-in-octopress/#comments">评论</a><a href="/blog/2012/04/21/using-code-in-octopress/#disqus_thread" class="comment-count"></a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在<a href="http://octopress.org">Octopress</a>中使用代码高亮, 实际就是<a href="http://jekyllrb.com/">Jekyll</a>的<a href="http://pygments.org/">Pygments</a>代码高亮, 效果如下</p>

<p>源</p>

<pre><code>``` js Javascript Hello World 
    alert('hello world');
```
</code></pre>

<p>效果</p>

<figure class='code'><figcaption><span>Javascript Hello World </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>而默认安装<a href="http://octopress.org">Octopress</a>时对代码高亮还是不支持的, 还需要安装<a href="http://python.org/">Python</a>, 我没有使用<a href="http://www.activestate.com/activepython">ActivePython</a>, 而是<a href="http://python.org/getit/">CPython</a>, 安装好后应该会有<code>c:\Windows\System32\python27.dll</code>.</p>

<p>但是现在还可能会出现<code>Could not open library’.dll’</code>的问题, 下面的修改会和版本有关, 我目前使用的Octopress版本是<code>2.0 2012/3/8 Commit:9f40242b1e7eb0098f0ef3c508c7bed7e647b982</code></p>

<p>将<code>Gemfile.lock</code>的<strong>33行</strong></p>

<pre><code>pygments.rb (0.1.3)
</code></pre>

<p>修改为</p>

<pre><code>pygments.rb (0.2.11)
</code></pre>

<p>以及<strong>40行</strong></p>

<pre><code>rubypython (0.5.1)
</code></pre>

<p>修改为</p>

<pre><code>rubypython (0.5.3)
</code></pre>

<p>注意上面的修改不要改变原有的缩进, 然后在命令行下执行</p>

<pre><code>bundle install
</code></pre>

<p>这将会使用<a href="http://gembundler.com/">bundler</a>这个依赖管理工具安装新版本的<a href="https://github.com/tmm1/pygments.rb/">pygments.rb</a>和<a href="http://rubypython.rubyforge.org/">rubypython</a>.</p>

<p>如果还有问题请参考<a href="http://hivan.me/octopress-install-to-windows8/">Windows 8安装Octopress记录</a>的<strong>部署Python</strong>部分.</p>

<h2>Octopress代码高亮的工作原理</h2>

<p>如果上面的还是不能使用代码高亮就需要了解原理之后在自行判断如何处理.</p>

<p><a href="http://octopress.org">Octopress</a>的代码高亮实际是<a href="http://jekyllrb.com/">Jekyll</a>的代码高亮, 其中插件<code>Backtick Code Blocks</code> <code>Code Blocks</code> <code>Include Code</code> 这些插件都有代码高亮功能, 其代码高亮都使用<code>Pygments Code</code>插件, 这个插件如名字所示, 其使用的gem库是<a href="https://github.com/tmm1/pygments.rb/">pygments.rb</a>.</p>

<p><a href="https://github.com/tmm1/pygments.rb/">pygments.rb</a>包含有<a href="http://pygments.org/">pygments</a>的代码, 可以在Ruby安装目录下的<code>\lib\ruby\gems\1.9.1\gems\pygments.rb-0.2.11\vendor</code>中看到.</p>

<p>使用<a href="http://gembundler.com/">bundler</a>安装<a href="https://github.com/tmm1/pygments.rb/">pygments.rb</a>时会自动的安装它依赖的<a href="http://rubypython.rubyforge.org/">rubypython</a>.</p>

<p><a href="https://github.com/tmm1/pygments.rb/">pygments.rb</a>使用<a href="http://rubypython.rubyforge.org/">rubypython</a>的方式为<a href="https://github.com/ffi/ffi">ffi</a>, 这个是ruby中调用C语言写的库的工具, 在这里是调用<code>python27.dll</code>.</p>

<h2>备用方案</h2>

<p>上述的方法还是不能正常使用代码高亮的话, 还可以使用一些后备的方法.</p>

<h3>Gist插件</h3>

<p>在<a href="https://gist.github.com/">github:gist</a>上贴代码, 并使用类似下面的代码</p>

<pre><code>{% gist 2436351 %}
</code></pre>

<p>将展示为</p>

<div><script src='https://gist.github.com/2436351.js?file='></script>
<noscript><pre><code>var parser = document.createElement('a');
parser.href = &quot;http://example.com:3000/pathname/?search=test#hash&quot;;

parser.protocol; // =&gt; &quot;http:&quot;
parser.host;     // =&gt; &quot;example.com&quot;
parser.port;     // =&gt; &quot;3000&quot;
parser.pathname; // =&gt; &quot;/pathname/&quot;
parser.search;   // =&gt; &quot;?search=test&quot;
parser.hash;     // =&gt; &quot;#hash&quot;</code></pre></noscript></div>


<p><a href="http://octopress.org/docs/plugins/gist-tag/">Gist Tag 插件的更多资料</a></p>

<h3>jsFiddle插件</h3>

<p>这个更适合用于web前端相关的html css js的展示, 使用类似下面的代码</p>

<pre><code>{% jsfiddle 3h5A4/3 %}
</code></pre>

<p>将展示为</p>

<iframe style="width: 100%; height: 300px" src="http://jsfiddle.net/3h5A4/3/embedded/js,resources,html,css,result/light/"></iframe>


<p><a href="http://octopress.org/docs/plugins/jsfiddle-tag/">jsFiddle Tag 插件的更多资料</a></p>
</div>
  
    <footer>
  
  
      <a href="/blog/2012/04/21/using-code-in-octopress/#comments">评论</a><a href="/blog/2012/04/21/using-code-in-octopress/#disqus_thread" class="comment-count"></a>
  
    </footer>


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; 上一页</a>
    
    <a href="/blog/archives">存档</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>近期日志</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/05/19/windows-shell-and-bat-skills/">Windows命令行和批处理技巧</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/19/csharp-delegate-and-lambda/">C#委托和Lambda表达式</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/06/ruby-and-jekyll-note/">Ruby 和 Jekyll 的笔记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/29/winforms-synchronizationcontext-and-invoke/">WinForms开发中SynchronizationContext和Invoke的使用注意事项</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/21/using-code-in-octopress/">在Octopress中使用代码高亮</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/21/camera-capture/">捕获摄像头信息</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/15/substring-with-bytes-length/">截取指定字节长度的字符串</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/15/object-undefined-in-jquery/">在jQuery中发生&#8217;Object&#8217; 未定义</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/07/mountain-climbing/">爬山备忘</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/25/unlock-google-play-android-market/">Google Play/Android Market 解锁</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/18/octopress-note/">Octopress 笔记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/18/hello-octopress/">Hello Octopress</a>
      </li>
    
  </ul>
</section>

<section>
    <h1 class="dsq-widget-title">近期评论</h1>
	<div id="recentcomments" class="dsq-widget">
		<script type="text/javascript" src="http://netwjxblog.disqus.com/recent_comments_widget.js?num_items=10&hide_avatars=1&avatar_size=32&excerpt_length=100"></script>
	</div>
	<a href="http://disqus.com/">Powered by Disqus</a>
</section>


<section>
    <h1 class="dsq-widget-title">热门话题</h1>
	<div id="popularthreads" class="dsq-widget">
		<script type="text/javascript" src="http://netwjxblog.disqus.com/popular_threads_widget.js?num_items=10"></script>
	</div>
	<a href="http://disqus.com/">Powered by Disqus</a>
</section>






<section>
	<h1>我的书签</h1>
	<div id="delicious"></div>
	<script type="text/javascript">
        $(window).on('load',function(){
            $(document.createElement('script')).attr('type','').attr('src','http://feeds.delicious.com/v2/json/netwjx?count=10&sort=date&callback=renderDeliciousLinks').appendTo('head');
        });
	</script>
	<a href="http://d.me/netwjx">我的书签 &raquo;</a>
</section>



<section>
  <h1>许可</h1>
  <div id="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/cn/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/2.5/cn/88x31.png" /></a><br /><a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/cn/">知识共享署名-相同方式共享 2.5</a></div>
</section>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - netwjx -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'netwjxblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
